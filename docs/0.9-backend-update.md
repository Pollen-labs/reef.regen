# ReefRegen — Data Model & Product Spec (Sites + Attestations)

Last updated: Oct 30, 2025

## Summary

This spec introduces **Sites** as first‑class records and upgrades **Attestations** to capture activity metadata, species counts, and action types. It matches the Location Protocol payload, supports MapLibre rendering, and stays lightweight for the MVP.

**Key decisions (confirmed):**

* One **Attestation** references exactly **one Site**. Many Attestations can occur on the same Site.
* One file per Attestation (stored as `ipfs_cid` and optional `gateway_url`).
* Contributors are ad‑hoc names (simple text array). No accounts required.
* Taxa counts stored per Attestation/Species pair (optional count).
* `regen_type.category` modeled as an enum; `stage` is free text.
* UTC dates; `action_end_date` is optional (UI may set it equal to start date for “single‑day” actions).
* Visibility toggle (`show_on_map`) to hide test data from maps.

## Phase scope (Backend v0.4)

**Goal:** Introduce Sites as first‑class records and upgrade Attestations to support multiple action types and species counts—while keeping costs and UX simple.

**What changes now**

1. **Sites:** new table with `site_name`, `site_type_id`, Location Protocol payload JSON, `location_point` (PostGIS), and normalized `lon`/`lat`; optional `depth_m` and `surface_area_m2`. Owned by a profile.
2. **Attestations:** add `site_id` (FK), `action_start_date`, optional `action_end_date`, `summary`, `contributors` (ad‑hoc names array), `internal_identifier` (unique per profile), `ipfs_cid` (single evidence file) and optional `file_gateway_url`, `show_on_map` toggle, optional `eas_attestation_uid`.
3. **Action types:** `regen_type` uses a **`category` enum** with the three approved values above; `stage` remains free text; optional link to `site_type`.
4. **Species:** `taxa` catalog (no external id). Attestations can reference many species, with optional integer `count` per species.
5. **Joins:** `attestation_regen_type` and `attestation_taxa` with composite PKs to prevent duplicates.
6. **Indexes:** GIST on site geolocation; standard FK indexes for performant map loading and lookups.

**Non‑goals in this phase**

* Multiple files per attestation, detailed contributor accounts/roles, donations, cross‑profile shared site moderation, and schema‑UID tracking are out of scope for v0.4.

**UX implications**

* Map shows each **Site** as an individual dot (no clustering). Clicking a dot opens a frontend panel that aggregates:

  * **Site name**
  * **Belongs to** (Profile name)
  * **Total action types** (unique regen types across all attestations at this site)
  * **Attestation count** (number of attestations at this site)
  * **Species involved** (unique taxa with optional total counts)
  * **Attestation items** (listing of individual attestations with date, actions, species subset, and file link if present)
* Creating an attestation always selects **one existing site** or creates a **new site**.

---

## Entities & Relationships

**Profiles** (existing) own **Sites** and create **Attestations**.

* **Site** — named point location with type, depth, area, and a Location Protocol payload.
* **Attestation** — a time‑bound activity at a Site, with optional summary, contributors, and one evidence file (IPFS CID). Optionally linked to EAS via `eas_attestation_uid`.
* **Regen Type** — controlled vocabulary of action types. Attestations can have many via a join table.
* **Taxa** — species catalog. Attestations can reference many species and optionally a count per species.

**Join tables:**

* `attestation_regen_type(attestation_id, regen_type_id)`
* `attestation_taxa(attestation_id, taxa_id, count)`

---

## Location Protocol Alignment

We store the raw payload (JSON) and also a PostGIS point + lon/lat for easy queries and EAS use.

**Example payload (`site.location_payload`):**

```json
{
  "srs": "EPSG:4326",
  "locationType": "coordinate-decimal/lon-lat",
  "location": [-103.771556, 44.967243],
  "specVersion": "1.0"
}
```

**Derived fields:**

* `location_point` (geography(Point, 4326))
* `lon` numeric(9,6), `lat` numeric(9,6) — normalized for EAS and quick UI access

---

## Table Specs (Postgres/Supabase)

### 1) `site_type`

Lookup for site categories shown in the UI.

| column         | type                      | notes                            |
| -------------- | ------------------------- | -------------------------------- |
| `site_type_id` | smallint PK               | seed from data source            |
| `name`         | text UNIQUE NOT NULL      | e.g., *Outplant reef*, *Nursery* |
| `description`  | text                      | optional                         |
| `created_at`   | timestamptz default now() |                                  |
| `updated_at`   | timestamptz default now() |                                  |

---

### 2) `site`

| column             | type                              | notes                      |
| ------------------ | --------------------------------- | -------------------------- |
| `site_id`          | uuid PK default gen_random_uuid() |                            |
| `profile_id`       | uuid NOT NULL                     | FK → `profile.profile_id`  |
| `site_name`        | text NOT NULL                     |                            |
| `site_type_id`     | smallint NOT NULL                 | FK → `site_type`           |
| `location_point`   | geography(Point,4326) NOT NULL    | GIST indexed               |
| `lon`              | numeric(9,6) NOT NULL             | normalized for EAS         |
| `lat`              | numeric(9,6) NOT NULL             | normalized for EAS         |
| `location_payload` | jsonb NOT NULL                    | raw Location Protocol JSON |
| `depth_m`          | numeric(6,2)                      | CHECK `>= 0`               |
| `surface_area_m2`  | numeric(12,2)                     | CHECK `>= 0`               |
| `created_at`       | timestamptz default now()         |                            |
| `updated_at`       | timestamptz default now()         |                            |

**Indexes:** GIST on `location_point`; btree on `(profile_id)`, `(site_type_id)`.

---

### 3) `regen_category` (enum)

Enum used by `regen_type.category`. **Final values** for MVP:

* `Asexual Propagation`
* `Sexual Propagation`
* `Substratum Enhancement`

---

### 4) `regen_type`

Controlled vocabulary for actions.

| column                 | type                      | notes                       |
| ---------------------- | ------------------------- | --------------------------- |
| `regen_type_id`        | integer PK                | seed from data source       |
| `name`                 | text UNIQUE NOT NULL      | canonical name              |
| `category`             | regen_category NOT NULL   | for UI grouping             |
| `description`          | text                      |                             |
| `std_label`            | text                      | short label for badges      |
| `stage`                | text                      | free text (optional)        |
| `primary_site_type_id` | smallint                  | FK → `site_type` (optional) |
| `aliases`              | text[]                    |                             |
| `created_at`           | timestamptz default now() |                             |
| `updated_at`           | timestamptz default now() |                             |

---

### 5) `taxa`

~5,000 species. Keep it minimal for MVP.

| column            | type                      | notes                        |
| ----------------- | ------------------------- | ---------------------------- |
| `taxa_id`         | integer PK                | sourced ID                   |
| `scientific_name` | text UNIQUE NOT NULL      | e.g., *Acropora cervicornis* |
| `common_name`     | text                      | optional                     |
| `created_at`      | timestamptz default now() |                              |
| `updated_at`      | timestamptz default now() |                              |

---

### 6) `attestation`

A single, time‑bound activity at a Site.

| column                | type                              | notes                     |
| --------------------- | --------------------------------- | ------------------------- |
| `attestation_id`      | uuid PK default gen_random_uuid() | internal ID               |
| `profile_id`          | uuid NOT NULL                     | FK → `profile.profile_id` |
| `site_id`             | uuid NOT NULL                     | FK → `site.site_id`       |
| `action_start_date`   | date NOT NULL                     | UTC date                  |
| `action_end_date`     | date                              | nullable                  |
| `summary`             | text                              | optional                  |
| `contributors`        | text[]                            | ad‑hoc names              |
| `internal_identifier` | text                              | scoped unique per profile |
| `ipfs_cid`            | text                              | evidence file             |
| `file_gateway_url`    | text                              | optional                  |
| `eas_attestation_uid` | text                              | optional (hex string)     |
| `show_on_map`         | boolean default true              | visibility toggle         |
| `created_at`          | timestamptz default now()         |                           |
| `updated_at`          | timestamptz default now()         |                           |

**Constraints & Indexes**

* UNIQUE (`profile_id`, `internal_identifier`) where `internal_identifier` is not null.
* Foreign key indexes on `profile_id` and `site_id`.

---

### 7) `attestation_regen_type`

| column           | type                      | notes              |
| ---------------- | ------------------------- | ------------------ |
| `attestation_id` | uuid NOT NULL             | FK → `attestation` |
| `regen_type_id`  | integer NOT NULL          | FK → `regen_type`  |
| `created_at`     | timestamptz default now() |                    |

**PK:** (`attestation_id`, `regen_type_id`)

---

### 8) `attestation_taxa`

| column           | type                      | notes                  |
| ---------------- | ------------------------- | ---------------------- |
| `attestation_id` | uuid NOT NULL             | FK → `attestation`     |
| `taxa_id`        | integer NOT NULL          | FK → `taxa`            |
| `count`          | integer                   | optional; CHECK `>= 0` |
| `created_at`     | timestamptz default now() |                        |

**PK:** (`attestation_id`, `taxa_id`)

---

## Seeding & Imports

* **`site_type`**: seed from your list (Outplant reef, Nursery, Lab/Hatchery, Staging/Holding, Other, ...).
* **`regen_type`**: seed from your curated dataset; ensure each row has a `category` enum value.
* **`taxa`**: bulk import from CSV. Recommended headers: `taxa_id,scientific_name,common_name`.

---

## Queries (MVP)

**1) Fetch sites + counts**

```sql
select
  s.site_id,
  s.site_name,
  s.lon, s.lat,
  count(a.attestation_id) as attestation_count
from public.site s
left join public.attestation a on a.site_id = s.site_id and a.show_on_map is true
where true
group by s.site_id, s.site_name, s.lon, s.lat;
```

**2) Get all attestations for a site**

```sql
select a.*
from public.attestation a
where a.site_id = $1
order by a.action_start_date desc nulls last;
```

**3) Attestation detail with actions & taxa**

```sql
select a.*, 
       coalesce(json_agg(distinct rt.name) filter (where rt.regen_type_id is not null), '[]') as actions,
       coalesce(json_agg(distinct jsonb_build_object('taxa_id', t.taxa_id, 'scientific_name', t.scientific_name, 'count', at.count))
                filter (where t.taxa_id is not null), '[]') as species
from public.attestation a
left join public.attestation_regen_type art on art.attestation_id = a.attestation_id
left join public.regen_type rt on rt.regen_type_id = art.regen_type_id
left join public.attestation_taxa at on at.attestation_id = a.attestation_id
left join public.taxa t on t.taxa_id = at.taxa_id
where a.attestation_id = $1
group by a.attestation_id;
```



### Notes

* **Counts** reflect only attestations with `show_on_map = true`.
* `action_count` counts *rows* in `attestation_regen_type` across the site (i.e., total individual actions recorded).
* Use `$2` to control how many recent attestation items the popup returns (default 5).
* For map performance you can later materialize `species_totals` and `attestation_count` in a per‑site stats view.
