# Reef.Regen ‚Äî Migration Guide: Web3Auth ‚ûú Privy Embedded Wallets

**Date:** 2025-10-31
**Owner:** Reef.Regen
Status: On hold

---

## üß≠ Overview

This document outlines how to migrate Reef.Regen from **Web3Auth embedded wallets** to **Privy embedded wallets**, maintaining the existing seamless UX for EAS attestations and relayer-based gas payments.

Users will continue to sign via an embedded wallet, but the wallet and login layer will now be handled entirely by **Privy**.

---

## üß© Goals

* Replace all Web3Auth references with Privy SDK (`@privy-io/react-auth`).
* Maintain one-click social/email login.
* Preserve current delegated EAS attestation + relayer submission flow.
* Keep user onboarding, Supabase profile linkage, and file upload behavior identical.

---

## ‚öôÔ∏è Architecture Before & After

| Layer         | Before                   | After                                        |
| ------------- | ------------------------ | -------------------------------------------- |
| Auth Provider | Web3AuthProvider         | PrivyProvider                                |
| Wallet Type   | Embedded Wallet          | Embedded Wallet (auto-created)               |
| SDK           | `@web3auth/*`            | `@privy-io/react-auth`                       |
| Signer        | `ethers.BrowserProvider` | `wallets[0].getEthersProvider().getSigner()` |
| Gas Strategy  | Custom relayer           | Same relayer (optional Privy sponsor later)  |
| EAS Signing   | Delegated attestation    | Same EAS path with signer adapter            |

---

## üß† Key Docs Reference

* [Privy ‚Äî Pregenerate Wallets](https://docs.privy.io/wallets/wallets/create/pregenerate-wallets)
* [Privy ‚Äî Get Connected Wallet](https://docs.privy.io/wallets/wallets/get-a-wallet/get-connected-wallet)
* [Privy + EAS Demo (DecentralizedGeo)](https://github.com/DecentralizedGeo/privy-eas-integration-demo/tree/main/docs)

---

## üß© Migration Steps

### 1. Install Privy SDK

```bash
pnpm install @privy-io/react-auth
```

Remove Web3Auth dependencies:

```bash
pnpm uninstall @web3auth/*
```

### 2. Setup Provider (app/providers.tsx)

```tsx
import { PrivyProvider } from '@privy-io/react-auth';

export default function Providers({ children }: { children: React.ReactNode }) {
  return (
    <PrivyProvider
      appId={process.env.NEXT_PUBLIC_PRIVY_APP_ID!}
      config={{
        loginMethods: ['google', 'apple', 'linkedin', 'email'],
        embeddedWallets: { createOnLogin: 'users-without-wallets' }
      }}
    >
      {children}
    </PrivyProvider>
  );
}
```

---

### 3. Replace Web3Auth Hooks

#### **Before**

```tsx
const { connectWeb3Auth, disconnectWeb3Auth, userInfo } = useWeb3Auth();
```

#### **After**

```tsx
import { usePrivy, useWallets } from '@privy-io/react-auth';

const { ready, authenticated, login, logout, user } = usePrivy();
const { wallets } = useWallets();
```

**Replace:**

* `connectWeb3Auth()` ‚Üí `login()`
* `disconnectWeb3Auth()` ‚Üí `logout()`
* `userInfo.email` ‚Üí `user.email`

Update checks:

```tsx
if (!ready || !authenticated) return <ConnectButton onClick={login} />;
```

---

### 4. Replace Signer Logic in AttestationForm

#### **Before**

```tsx
const provider = new ethers.BrowserProvider(embeddedProvider);
const signer = await provider.getSigner();
```

#### **After**

```tsx
const { wallets } = useWallets();
const provider = await wallets[0].getEthersProvider();
const signer = provider.getSigner();
```

Use the signer normally for EAS signing:

```ts
const signature = await signer.signTypedData(domain, types, value);
```

---

### 5. Maintain EAS + Relayer Flow

No backend or API changes needed.

```ts
// Still valid
const delegated = await eas.getDelegated().signDelegatedAttestation(data, signer);
await fetch('/api/relay', { method: 'POST', body: JSON.stringify(delegated) });
```

If needed for ethers v6 compatibility, add a signer adapter:

```ts
import { ethers } from 'ethers';
const provider = new ethers.BrowserProvider(wallets[0].getEthersProvider());
const signer = await provider.getSigner();
```

---

### 6. Update TopNav + WalletConnect

* Replace `useWeb3AuthConnect` / `Disconnect` with Privy hooks.
* Preserve redirect & Supabase `profile` upsert.
* Use `user.email` instead of `userInfo.email`.

Example:

```tsx
const { authenticated, login, logout, user } = usePrivy();
const { wallets } = useWallets();

{!authenticated ? (
  <button onClick={login}>Connect Wallet</button>
) : (
  <button onClick={logout}>Disconnect</button>
)}
```

---

### 7. Chain Management

Privy wallets support standard EIP-1193 calls.

```ts
await window.ethereum.request({
  method: 'wallet_switchEthereumChain',
  params: [{ chainId: '0xaa37dc' }], // Optimism Sepolia
});
```

---

### 8. Testing Checklist

| Test              | Expected Behavior                      |
| ----------------- | -------------------------------------- |
| Login with Google | Creates embedded wallet + session      |
| Email login       | Creates embedded wallet                |
| EAS attestation   | Signs + relays successfully            |
| Chain switch      | Works via `wallet_switchEthereumChain` |
| Logout/Login      | Wallet persists on reconnect           |

---

## ‚úÖ Migration Summary (Codebase-Specific)

- Files to update
  - `app/providers.tsx`: swap `Web3AuthProvider`/`WagmiProvider` for `PrivyProvider` with `NEXT_PUBLIC_PRIVY_APP_ID` and `embeddedWallets.createOnLogin = 'users-without-wallets'`.
  - `components/TopNav.tsx`: replace `useWeb3AuthConnect` + wagmi `useAccount` with `{ login } = usePrivy()` and `{ wallets } = useWallets()`; compute `isConnected = authenticated && wallets.length > 0` and `address = wallets[0]?.address`.
  - `components/WalletConnect.tsx`: replace `useWeb3Auth*` hooks with `{ ready, authenticated, login, logout, user } = usePrivy()` and `{ wallets } = useWallets()`; use `user?.email` for Supabase upsert.
  - `components/AttestationForm.tsx`: remove `useWeb3Auth`, use Privy wallet: `const wallet = wallets[0]; const provider = await wallet.getEthersProvider(); const signer = await provider.getSigner(); const attesterAddr = await signer.getAddress();` Replace wagmi `useAccount` with `wallet?.address`.
  - `components/ProfileEditor.tsx`: replace wagmi `useAccount` with Privy address from `wallets[0]?.address` when computing `canEdit`.

- Hook and API mappings
  - `connectWeb3Auth()` ‚Üí `login()`; `disconnectWeb3Auth()` ‚Üí `logout()`; `userInfo.email` ‚Üí `user?.email`.
  - EIP-1193 provider: `embeddedProvider` ‚Üí `await wallets[0].getEthereumProvider()`.
  - Ethers v6 provider: replace `new ethers.BrowserProvider(embeddedProvider)` with `await wallets[0].getEthersProvider()`.

- Chain switching and reads
  - Chain switch: `await (await wallets[0].getEthereumProvider()).request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xaa37dc' }] })`.
  - EAS nonce (no wagmi): `const eas = new ethers.Contract(env.easAddress, EAS_GET_NONCE_ABI, provider); const chainNonce = await eas.getNonce(address);`.

- EAS delegated attestation flow
  - Keep existing delegated signing and `/api/relay` POST; only the signer/provider source changes. BigInt-to-string JSON serialization remains.

- Env and dependencies
  - Ensure `.env` has `NEXT_PUBLIC_PRIVY_APP_ID` (already present) and `NEXT_PUBLIC_AUTH_PROVIDER=privy` for rollout.
  - Add `@privy-io/react-auth`; plan to remove `@web3auth/*` and unused wagmi after validation.

- Rollout plan
  - Phase 1: behind feature flag (`NEXT_PUBLIC_AUTH_PROVIDER`), add Privy provider + components; keep Web3Auth paths for quick rollback.
  - Phase 2: after testing, remove Web3Auth deps and wagmi usages; simplify to Privy-only.

- Pitfalls and mitigations
  - Do not use `window.ethereum` when multiple providers exist; always use `wallets[0].getEthereumProvider()`.
  - Replace all `useAccount`/`usePublicClient` usages; otherwise builds will fail post-wagmi removal.
  - Only fetch EAS nonce after a wallet/address is available (matches current behavior).

---

### 9. Optional Enhancements

* Enable **pregenerated wallets** for pre-invite accounts.
* Test **gas sponsorship** once Privy supports Optimism Sepolia.
* Add **address linking** flow if needed to associate old Web3Auth wallets.

---

### ‚úÖ Completion Checklist

* [ ] Replace all Web3Auth imports with Privy SDK.
* [ ] Update Providers & hooks.
* [ ] Verify embedded wallet creation on first login.
* [ ] Sign and relay EAS attestation successfully.
* [ ] Test logout/login persistence.
* [ ] Clean old Web3Auth env vars and secrets.

---

**Migration Outcome:**
Reef.Regen continues to support gasless attestations and seamless user login, now powered by Privy‚Äôs stable embedded wallets and identity layer.
