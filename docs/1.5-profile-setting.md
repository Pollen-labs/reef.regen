# Reef.Regen â€” Profile / Settings Specification

**Route:** `/profile/setting`
**API base:** `/api/profile`

---

## ğŸ§­ Overview

The **Profile / Settings** page lets users manage their organization profile, handle, and wallet access.
Itâ€™s only visible to the authenticated user viewing their own account.

The page is divided into three sections:

1. **Basic Information** â€” profile metadata editable anytime.
2. **Sites** â€” manage owned reef restoration sites.
3. **Security** â€” wallet info, private key export, and logout.

---

## ğŸ§© Page Layout

| Section               | Fields                                                  | Actions                     |
| --------------------- | ------------------------------------------------------- | --------------------------- |
| **Basic Information** | Organization name, description, website, handle         | Save / Cancel               |
| **Sites**             | Add & manage restoration sites                          | Add Site button (map modal) |
| **Security**          | Wallet address (read-only), export private key, log out | Buttons                     |

---

## ğŸ§± 1. Basic Information Section

### Fields

| Field                 | Type        | Rules                                      | Notes                                             |
| --------------------- | ----------- | ------------------------------------------ | ------------------------------------------------- |
| **Organization name** | Text        | 2â€“80 chars                                 | Required                                          |
| **Description**       | Multiline   | â‰¤ 500 chars                                | Optional                                          |
| **Website**           | URL         | Must start with `http://` or `https://`    | Optional                                          |
| **Handle**            | Text (slug) | Unique, lowercase, 3â€“32 chars, `[a-z0-9-]` | Required, must be unique across `profiles.handle` |

### Behavior

* Inputs are **editable inline**.
* â€œSaveâ€ button is disabled if no changes are made.
* â€œCancelâ€ restores last saved data.
* On save:

  * PATCH `/api/profile`

    ```json
    {
      "profile_name": "Coral Guardians Initiative",
      "description": "...",
      "website": "https://www.com",
      "handle": "reef-123"
    }
    ```
  * Returns `{ success: true, updated_at: "..." }`
  * Shows toast: â€œProfile updated successfully.â€

### Handle Uniqueness Check

* Debounce input (400ms) and check:

  * `GET /api/profile/check-handle?handle=reef-123`
  * Response: `{ available: true }` or `{ available: false }`
* If unavailable â†’ red text warning: â€œHandle already taken.â€

---

## ğŸª¸ 2. Sites Section

### Description

Displays existing sites and allows adding new ones.
Reuses the **Step 2 â€œEdit siteâ€ modal** component for add/edit operations.

### UI elements

* Existing sites listed in a simple list:

  ```
  Site name, Type, Depth (m)
  [Edit Icon]
  ```
* â€œAdd a siteâ€ button opens the Map modal (same as submission flow).

### Interactions

| Action                     | Behavior                                                                                         |
| -------------------------- | ------------------------------------------------------------------------------------------------ |
| **Add Site**               | Opens `SiteModal` (map + form). Creates site via `POST /api/sites`.                              |
| **Edit Site**              | Opens same modal with data loaded from `GET /api/sites/:id`. Updates via `PATCH /api/sites/:id`. |
| **Delete Site (optional)** | Small trash icon â†’ confirmation â†’ `DELETE /api/sites/:id`.                                       |

### API

**POST /api/sites**

```json
{
  "name": "Koh Tao",
  "type": "Nursery",
  "depth_m": 5,
  "area_m2": 167,
  "location": [99.841, 10.112]
}
```

**PATCH /api/sites/:id**

```json
{ "name": "Koh Tao", "depth_m": 7 }
```

**GET /api/sites**
â†’ returns list of userâ€™s sites.

---

## ğŸ” 3. Security Section

### Fields

| Field                  | Type           | Behavior                                     |
| ---------------------- | -------------- | -------------------------------------------- |
| **Wallet address**     | Read-only text | Always show truncated form (`0x1234...ABCD`) |
| **Export private key** | Button         | Starts secure key export process             |
| **Log out**            | Button         | Disconnect embedded wallet session           |

---

### Export Private Key Flow

#### Background

Uses the Web3Auth Embedded Wallet or Metamask Embedded Dashboard.
See reference: [Metamask Embedded Wallet â€” Key Export](https://docs.metamask.io/embedded-wallets/dashboard/advanced/key-export)

#### Flow

1. User clicks **â€œExport private keyâ€**.
2. System requests wallet export permission (requires backend-verified token).
3. If enabled, show modal:

   > â€œExport your wallet key (use with caution).â€
4. User confirms; app calls the export API:

```ts
const key = await metamaskSDK.exportPrivateKey();
```

5. Prompt browser to download file:

   * Filename: `reefregen-wallet-key.txt`
   * Contents: the exported key string
   * (Use `FileSaver` or `Blob` API)
6. Show warning toast:

   > â€œYour private key has been downloaded. Keep it secure.â€

#### Safety notice

* Show inline warning message below button:

  > â€œâš ï¸ Do not share your private key. Anyone with this key can access your funds.â€
* Disable in **Public View** and **when embedded wallets are locked**.

---

### Log Out

* Ends the Privy or Web3Auth session.
* Clears local session & redirect to `/`.
* Implementation:

  ```ts
  await privy.logout(); // or web3auth.logout()
  localStorage.clear();
  router.push('/');
  ```
* Confirmation modal:

  > â€œAre you sure you want to log out?â€

---

## ğŸ§© UI Details

### Buttons

| Button             | Style               | State                          |
| ------------------ | ------------------- | ------------------------------ |
| Save               | Primary (orange)    | Disabled if no changes         |
| Cancel             | Outline             | Active only when unsaved edits |
| Add site           | Ghost with map icon | Opens site modal               |
| Export private key | Outline gray        | Warning hover state            |
| Log out            | Red outline         | Confirmation required          |

### Input styling

* Same style as onboarding forms.
* 100% width, `rounded-xl`, dark background.
* Multiline description box ~150px height.

---

## ğŸ”„ Data Sync

| Event             | Action                        |
| ----------------- | ----------------------------- |
| On load           | Fetch `/api/profile/me`       |
| On save           | PATCH `/api/profile`          |
| After site change | Re-fetch `/api/sites`         |
| On export         | Call Web3Auth or Metamask SDK |
| On logout         | Clear local state, redirect   |

---

## âœ… QA Checklist

* [ ] Org name, description, and website update correctly.
* [ ] Handle uniqueness validation works with debounce.
* [ ] â€œSaveâ€ disabled until something changes.
* [ ] Site list loads and updates after add/edit/delete.
* [ ] â€œExport private keyâ€ triggers download with correct data.
* [ ] Logout clears wallet and session cleanly.
* [ ] No sensitive data shown in console or network logs.

---

## ğŸ§  API Summary

| Method   | Endpoint                             | Purpose                  |
| -------- | ------------------------------------ | ------------------------ |
| `GET`    | `/api/profile/me`                    | Fetch current profile    |
| `PATCH`  | `/api/profile`                       | Update profile info      |
| `GET`    | `/api/profile/check-handle?handle=x` | Verify handle uniqueness |
| `GET`    | `/api/sites`                         | List owned sites         |
| `POST`   | `/api/sites`                         | Add site                 |
| `PATCH`  | `/api/sites/:id`                     | Edit site                |
| `DELETE` | `/api/sites/:id`                     | Remove site              |

---

## ğŸ§© Component Breakdown

```
ProfileSettingsPage
â”œâ”€ ProfileForm (Basic Info)
â”‚  â”œâ”€ OrgNameInput
â”‚  â”œâ”€ DescriptionTextarea
â”‚  â”œâ”€ WebsiteInput
â”‚  â”œâ”€ HandleInput (with uniqueness check)
â”‚  â””â”€ Save/Cancel buttons
â”œâ”€ SiteManager
â”‚  â”œâ”€ SiteList
â”‚  â”œâ”€ AddSiteButton â†’ SiteModal
â”œâ”€ SecuritySection
â”‚  â”œâ”€ WalletDisplay
â”‚  â”œâ”€ ViewWalletButton
â”‚  â”œâ”€ LogoutButton
```

---

## ğŸ’¡ Notes

* Use optimistic UI for save updates.
* If Web3Auth disables key export, hide button (check via dashboard config).
* Ensure all requests include user auth header (`supabase.auth.getSession()`).
* Long-term: consider adding profile avatar/logo upload.

---
