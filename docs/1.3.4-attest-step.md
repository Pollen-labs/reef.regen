# Reef.Regen — Attestation Wizard

## Step 4: Species (Taxa) & Counts

**Goal:** Let users optionally add one or more species from the **taxa** table and (optionally) provide counts for each. All data is **client-only** (stored in the wizard store + localStorage). No server writes until final submit.

---

## 1) UX overview

**Header:** “Now, the science part” + short subcopy.
**Controls:**

* **Search box** (type to search taxa)
* **Add to the list** button (adds the highlighted/typed selection)
* **Results dropdown** (appears under the search box)
* **Table (list) of selected species** with two columns:

  * Species name
  * Counts (optional, integer ≥ 0)
  * Row actions: **Delete**

**Footer:** Back | Next (always enabled). Show “Saved • HH:MM” when state persists.

**Everything in this step is optional.** Users can skip without adding anything.

---

## 2) State model (Zustand + persist)

```ts
type SpeciesEntry = {
  taxonId: string;         // canonical id from `taxa` table
  scientificName: string;  // label shown in UI
  count?: number | null;   // integer ≥ 0; null/undefined = not provided
};

type WizardState = {
  // ...
  species: SpeciesEntry[];   // default []
};
```

* Persist `species` with the rest of the wizard state.
* Update `lastSavedAt` on any add/remove/edit.

---

## 3) API contracts

### Search taxa

* `GET /api/taxa/search?q=<query>&limit=20`

  * Returns `[{ id, scientific_name }]` (exact shape as your current API is fine).
  * Results should be ordered by relevance (prefix matches first), then alphabetically.
  * Respond quickly (<250ms target). Support empty results.

> If you already have a server endpoint for this from the single-page form, reuse it.

---

## 4) Search & dropdown behavior

* **Debounce** the query by **250 ms** before hitting the API.
* Minimum 2 characters before searching.
* **Keyboard support**

  * `ArrowDown/ArrowUp` cycles through results.
  * `Enter` selects the highlighted result.
  * `Esc` closes the dropdown.
* **Mouse support**

  * Clicking a result selects it.
* **No results** state: show “No matches. Try a different name.”
* **Selection display**

  * On selection, populate the search input with the chosen **scientific name**.
  * The dropdown closes.
* **Add to the list**

  * Clicking the “Add to the list” button (or pressing `Enter` while search has a selected item) **appends** the selected species to the table (details below).

**Important:** Users cannot “free type” arbitrary species—entries must come from the taxa table (no custom rows), to keep data clean.

---

## 5) Adding to the list

When “Add to the list” is triggered:

1. Validate a selection exists (i.e., we have `{id, scientific_name}` in the component’s local state).
2. **Deduplicate**:

   * If the species is already in `state.species` (same `taxonId`), do not add again.
   * Instead, briefly highlight the existing row and scroll it into view.
3. Append to `state.species`:

   ```ts
   setPatch({
     species: [...species, { taxonId: id, scientificName: scientific_name, count: null }]
   });
   ```
4. Clear the search input and close the dropdown.
5. Focus the new row’s **Counts** input to invite optional entry.

---

## 6) Table / list interactions

Each row shows:

* **Species name**: render as normal text (or italicize scientific names if desired).
* **Counts (Optional)**: a numeric input:

  * Accepts integers only (`0..1,000,000`; configurable).
  * Empty means “not provided.”
  * Typing non-digits is ignored; pasting is sanitized.
  * On blur, coerce to integer or clear if invalid.
* **Delete** icon button:

  * Removes the row.
  * If it was the last row, the table returns to empty state.

**Row keyboarding**

* `Tab` moves between counts in consecutive rows.
* `Delete` (while the row is focused via a hidden checkbox or button) removes the row (optional).

**Empty state**

* Show a soft hint under the table: “Add a species using the search above.”

---

## 7) Validation rules

* **No required fields** here.
* **Counts** must be integer ≥ 0 if provided.
* Hard limit of **200 species** per attestation (guardrail; adjust if needed).
* **Next** remains enabled, regardless of contents. Display inline error if a count is invalid but do not block navigation; invalid values simply won’t save until corrected.

---

## 8) Persistence & autosave

* On **add/remove/edit**:

  * Update `species` in store immediately.
  * Update `lastSavedAt` to show “Saved • …”.
* The table must fully restore on reload from localStorage.

---

## 9) Edge cases & behaviors

* **Selecting the same species again** → dedupe & highlight existing row.
* **Typing quickly then clicking Next** → ensure debounced search doesn’t overwrite input; we only add on explicit “Add to the list”.
* **Switching steps** → keep state intact.
* **Long names** → truncate with ellipsis and `title` attribute for full name.
* **Mobile** → dropdown uses the full width under the input; table rows remain tap-friendly (44px min height).

---

## 10) Accessibility

* Search input: `aria-autocomplete="list"`, `role="combobox"`, `aria-expanded`, `aria-controls="<id-of-listbox>"`.
* Results: `role="listbox"`; each item `role="option"` with `aria-selected`.
* “Add to the list” is a standard button with clear label.
* Table headers: “Species name”, “Counts (Optional)”.
* Delete buttons have `aria-label="Remove <Species name>"`.

---

## 11) Performance

* Debounce search (250 ms).
* Cancel previous fetch if a new query starts (AbortController).
* Limit results to 20 per request.
* Virtualize the dropdown if you expect >100 results (probably unnecessary with limit 20).

---

## 12) QA checklist

* Typing ≥2 chars opens dropdown; results update as expected.
* Keyboard navigation + Enter adds the highlighted species.
* “Add to the list” without a selected species does nothing (disabled or shows tooltip).
* Duplicate selections do not create duplicate rows; existing row is highlighted.
* Counts accept integers; negative or non-integers are rejected/cleaned.
* Remove row works; undo isn’t required.
* Step navigation preserves state.
* Reload preserves the selected species list and counts.

---

## 13) Final submit mapping (later)

When building the final payload:

```ts
// For DB/EAS mapping
const speciesForSubmit = state.species.map(s => ({
  taxon_id: s.taxonId,
  scientific_name: s.scientificName, // optional for DB denormalization
  count: (s.count ?? null)
}));
```

* Include `speciesForSubmit` in the DB create request.
* EAS payload: follow your schema (e.g., serialize as an array of `(taxonId, count)` pairs; or include scientific names if space allows).

---

## 14) Minimal UI copy

* Placeholder: “Search here”
* Button: “Add to the list”
* Headers: “Species name”, “Counts (Optional)”
* Empty hint: “Add a species using the search above”
* Duplicate toast (optional): “Already in your list”


