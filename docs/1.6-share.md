# Reef.Regen â€” Social Sharing & Dynamic OG Image Spec (Simplified)

**Owner:** Reef.Regen (Pollen Labs)
**Date:** 2025-11-06
**Status:** Ready for Implementation

---

## 1) Overview

When a user completes a submission (an attestation tied to a site), they can share a **public, crawlable URL** such as:

```
/map?site=<site_id>&att=<attestation_id>
```

Social platforms (X/Twitter, Facebook, etc.) should render a **dynamic Open Graph image** with a fun sticker, the Reef.Regen logo, and the organizationâ€™s name. This image is generated **on demand** via `next/og` (Edge runtime) â€” no file storage required.

---

## 2) Goals

* Publicly viewable URL per submission/site.
* Fast, dynamic OG image generation using Edge runtime (no database writes).
* Image includes only: **Reef.Regen logo**, **org name**, and a **sticker**.
* Sticker selection rotates automatically (time-based or deterministic by ID).
* One-click share buttons for Twitter/X, Facebook, and native Web Share.

---

## 3) Public URL

**Base format:**

```
/map?site=<uuid>&att=<uuid>
```

**Canonical optional routes:**

* `/a/<attestationId>` â†’ redirect to `/map?...`
* `/s/<siteId>` â†’ redirect to `/map?...`

The page must be:

* Accessible without auth.
* Exclude all private or sensitive data.
* Have canonical link and OG/Twitter meta tags.

---

## 4) OG Image Generation

**Route:** `/opengraph/map/route.tsx`
**Runtime:** Edge
**Size:** 1200Ã—630
**Format:** PNG (`image/png`)

### Data fetched

`getPublicSharePayload(siteId, attId?)` â†’ `{ orgName, createdAtMs }`

Only minimal, public-safe data is needed.

### Rendering flow

1. Parse query (`site`, `att`).
2. Fetch payload.
3. Select sticker (see Â§5 below).
4. Compose image (logo + text + sticker) using `ImageResponse`.
5. Serve PNG with cache header `revalidate = 3600` (1 hour).

**No storage:** Images are never saved; they are rendered instantly and cached by CDN/Edge.

---

## 5) Sticker Selection Logic

You can keep this stateless and fun. Two simple options:

### A) Time-based rotation

Every 10 minutes, the active sticker changes globally.

```ts
const STICKERS = ["a.png", "b.png", "c.png", "d.png"];
function pickStickerByTime(createdAtMs: number) {
  const BUCKET_MS = 10 * 60 * 1000;
  const bucket = Math.floor(createdAtMs / BUCKET_MS);
  return STICKERS[bucket % STICKERS.length];
}
```

### B) Deterministic by ID

Ensures each submission/site gets the same sticker every time.

```ts
function hashToIndex(s: string, n: number) {
  let h = 0; for (let i=0;i<s.length;i++) h = (h*31+s.charCodeAt(i))|0;
  return Math.abs(h)%n;
}
const STICKERS = ["a.png","b.png","c.png","d.png"];
function pickStickerById(id: string){ return STICKERS[hashToIndex(id, STICKERS.length)]; }
```

---

## 6) Minimal OG Image Layout

**Canvas:** 1200Ã—630
**Theme:** Dark background `#15171e`

### Left Section (Text)

* Reef.Regen logo top-left (160Ã—64px)
* Copy: â€œCoral restoration action byâ€ (small text)
* Org name: large, bold, up to 36 chars, line clamp x2

### Right Section (Sticker)

* Random sticker from `/public/og/stickers/`
* Sized ~360Ã—360px
* Background block `#222533`, rounded 24px

### Example Layout (pseudocode)

```
| LOGO            |  [STICKER]       |
| 'Coral by Org'  |                  |
```

### Example implementation

```tsx
export const runtime = "edge";
export const size = { width: 1200, height: 630 };
export const contentType = "image/png";
export const revalidate = 3600;

export async function GET(req) {
  const { searchParams } = new URL(req.url);
  const site = searchParams.get("site");
  const att = searchParams.get("att");
  const payload = await getPublicSharePayload(site, att);

  const sticker = pickStickerByTime(payload.createdAtMs);
  const logo = `${process.env.NEXT_PUBLIC_APP_URL}/og/logo.png`;

  return new ImageResponse(
    <div style={{ width:1200, height:630, background:'#15171e', color:'white', display:'flex', padding:40, gap:40 }}>
      <div style={{ flex:1, display:'flex', flexDirection:'column', justifyContent:'space-between' }}>
        <img src={logo} width={160} height={64} alt="Reef.Regen" />
        <div>
          <div style={{ opacity:0.8, fontSize:28 }}>Coral restoration action by</div>
          <div style={{ fontSize:64, fontWeight:800 }}>{payload.orgName}</div>
        </div>
      </div>
      <div style={{ width:420, height:420, borderRadius:24, background:'#222533', display:'flex', alignItems:'center', justifyContent:'center' }}>
        <img src={`${process.env.NEXT_PUBLIC_APP_URL}/og/stickers/${sticker}`} width={360} height={360} alt="sticker" />
      </div>
    </div>,
    size
  );
}
```

---

## 7) Metadata on `/map` Page

```ts
export async function generateMetadata({ searchParams }) {
  const { site, att } = searchParams || {};
  const base = new URL(process.env.NEXT_PUBLIC_APP_URL!);
  const og = new URL("/opengraph/map", base);
  if (site) og.searchParams.set("site", site);
  if (att) og.searchParams.set("att", att);

  return {
    metadataBase: base,
    title: "Coral restoration action Â· Reef.Regen",
    description: "See this action on Reef.Regen.",
    openGraph: {
      type: "website",
      url: `/map?site=${site}&att=${att}`,
      images: [{ url: og.toString(), width: 1200, height: 630 }],
    },
    twitter: {
      card: "summary_large_image",
      images: [og.toString()],
    },
  };
}
```

---

## 8) Share Buttons

**Component:** `ShareButtons` (client-side)

```tsx
import { usePathname } from 'next/navigation';

export default function ShareButtons({ url, text }) {
  const shareData = { title: 'Reef.Regen', text, url };

  const twitter = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}&hashtags=ReefRegen`;
  const fb = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;

  return (
    <div className="flex gap-2">
      <button onClick={() => navigator.share?.(shareData)}>Share</button>
      <a href={twitter} target="_blank">Share on X</a>
      <a href={fb} target="_blank">Share on Facebook</a>
    </div>
  );
}
```

Default text: `I just logged a coral restoration action on Reef.Regen ðŸŒŠ #ReefRegen`

---

## 9) Performance & Cache

* Runtime: Edge.
* CDN cache: 1 hour (`revalidate = 3600`).
* Fonts and stickers preloaded from `/public` for instant edge fetch.
* No persistent storage or database writes.

**Expected render time:** < 400ms at cold start.

---

## 10) Acceptance Criteria

* OG image shows Reef.Regen logo, org name, and a fun sticker.
* URL `/map?site=<id>&att=<id>` generates correct OG tags.
* Image appears correctly on X/Twitter, Facebook, and iMessage.
* Sticker changes predictably (based on ID or time).
* No private data displayed.
* Render time < 500ms (p95).

---

## 11) Future Enhancements

* User-selectable sticker pack before sharing.
* Add gradient background variations by sticker.
* Autoâ€‘localize text (e.g., French/Spanish).
* Support animated OG for social previews (optional).

---

## Summary

This spec defines a **fast, stateless OG image system** for Reef.Regen using Next.js Edge runtime. Each shared map or attestation link generates a **playful, branded image** with the logo, org name, and randomized sticker â€” perfect for lightweight social sharing without backend overhead.
