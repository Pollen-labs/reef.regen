# Reef.Regen — Attestation Wizard

## Step 3: Summary & Attachment (Client-only)

### Purpose

Collect an optional summary and **one optional file** (≤ 5 MB).
All data is stored **locally** (Zustand + localStorage). **No server calls** happen in this step. The file itself stays **in memory** only; we upload it at final submit.

---

## 1) UX

**Title:** “Tell us more about this action & attach a file.”
**Sections:**

* **Summary** — multiline textarea with soft cap 1,500 chars and live counter.
* **Attachment** — single-file picker with drag-and-drop.

  * Help text: “Optionally attach a file relevant to this action (notes, spreadsheet, photo, etc.). Max 1 file, 5 MB.”
  * After select: show row with name, size, type, and **Remove** (×).

**Footer:** Back | Next

* Both always enabled. “Saved • HH:MM” indicator when local save occurs.

**Errors (non-blocking):**

* If file > 5 MB ⇒ show inline error and **do not** store it.
* If user had a file before reload, show a subtle “Please re-attach to include it on submit.”

---

## 2) State (Zustand + persist)

Extend the wizard store:

```ts
type WizardState = {
  // ...
  summary?: string;

  // Persisted metadata (safe for localStorage)
  fileName?: string | null;
  fileSize?: number | null;
  fileType?: string | null;

  // Volatile: not persisted; kept only in memory during the session
  fileBlob?: File | null;

  lastSavedAt?: number;
};

const useAttestationWizard = create(
  persist(
    (set, get) => ({
      // ...
      setPatch: (p: Partial<WizardState>) =>
        set({ ...p, lastSavedAt: Date.now() }),
    }),
    {
      name: 'reefregen.attestation.wizard.v1',
      // IMPORTANT: never persist the File object
      partialize: (s) => {
        const { fileBlob, ...rest } = s as WizardState;
        return rest;
      },
    }
  )
);
```

---

## 3) Component structure

```
/submit/steps/3
  └─ Step3SummaryFile.tsx
     ├─ SummaryTextarea (debounced onChange)
     ├─ SingleFileInput (drag & drop; replace-on-select)
     └─ WizardFooter (Back / Next + Saved time)
```

---

## 4) Behaviors

### Summary

* Controlled textarea.
* Debounce writes to store by ~250ms:

  ```ts
  setPatch({ summary: value });
  ```
* Soft limit 1500 chars (show counter; allow typing beyond but truncate on save if you prefer).

### File picker

* Accept any type (you can whitelist later).
* On select:

  * Reject if `file.size > 5*1024*1024` → show error and return.
  * Otherwise:

    ```ts
    setPatch({
      fileBlob: file,        // memory-only
      fileName: file.name,   // persisted
      fileSize: file.size,
      fileType: file.type,
    });
    ```
* On remove:

  ```ts
  setPatch({ fileBlob: null, fileName: null, fileSize: null, fileType: null });
  ```
* On reload:

  * If `fileName` exists but `fileBlob` is `null`, render a muted row:

    * “{fileName} — re-attach to include it” + **Re-attach** button (opens chooser).

### Navigation

* **Back/Next** simply change `currentStep` and leave state intact.

---

## 5) No server traffic in Step 3

* **No draft create/patch** here.
* Keep everything local until final submit (Step 5).
* Rationale: prevents server “ping storm,” avoids orphan drafts.

---

## 6) Final submit (handled later)

When the user reaches **Sign & Submit**:

1. If `fileBlob` exists:

   * Upload to Filebase/IPFS → get `cid` + `gatewayUrl`.
   * `setPatch({ fileCid: cid, fileUrl: gatewayUrl })`.
2. Build the EAS payload + DB create:

   * Include `summary` if present.
   * Include file fields (`cid`, `gatewayUrl`, `fileName`) if available.
3. Sign & relay to EAS; update DB with `eas_uid`.
4. `reset()` the store.

If `fileName` is present but `fileBlob` is missing at submit time (user reloaded):

* Show blocking modal: “Please re-attach ‘{fileName}’ or remove it to continue.”
* Provide **Re-attach** and **Remove** actions.

---

## 7) Accessibility & polish

* Textarea has `aria-label="Summary"`.
* File input has keyboard focus and `aria-describedby` pointing to the max-size helper text.
* Drag-over adds a visible outline; dropping the file triggers the same validation path.

---

## 8) QA checklist

* Summary persists across reloads; “Saved” timestamp updates.
* Valid file shows row; persists **metadata** across reloads (not the blob).
* Over-limit file rejected; previous valid file (if any) remains.
* Remove clears file state correctly.
* After reload with only metadata, “re-attach” hint appears.
* Back/Next do not drop state.
* Final submit flow (when implemented) uploads only if `fileBlob` exists.

---

## 9) Minimal UI copy

* Placeholder: “Describe anything you judge relevant to the current action(s)”
* Helper: “Max 1 file, 5 MB”
* Re-attach hint: “Previously selected: **{fileName}** — re-attach to include it.”

---
