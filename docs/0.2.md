# üåä Coral Action Attestation MVP ‚Äî Product Requirements Document (PRD)

**Version:** v0.1 (MVP)
**Last Updated:** October 18, 2025

---

## üéØ Product Overview

Enable marine researchers, NGOs, and community projects to record, verify, and publicly display coral restoration actions as on-chain attestations.

---

## ‚úÖ Delivery Status (MVP)

- Live network: Optimism Sepolia (`11155420`)
- EAS contract: `0x4200000000000000000000000000000000000021`
- Deployed schema UID: `0xa3950a0da6321874b64dc329abff0119970bd34ffe9d2c1ed43446fd8ee7dd46`
- Cloudflare Worker relayer: deployed and verifying signatures; schema-allowlist enabled
- Supabase: schema + RLS in place; server routes wired from Next.js
- Frontend: Connect, Attest, Map (MapLibre), and Profile pages
- Map: uses Dark Matter style via MapTiler with API key; popups link to profile + EAS
- Profile editing: org name, website, description (owner-only)

Quick links
- EAS schema: https://optimism-sepolia.easscan.org/schema/view/0xa3950a0da6321874b64dc329abff0119970bd34ffe9d2c1ed43446fd8ee7dd46
- Relayer health (proxied): `/api/relay` ‚Üí returns `{ eas, schema, chainId }`

## üß© System Components

| Component                       | Tech                                    | Purpose                                                                    |
| ------------------------------- | --------------------------------------- | -------------------------------------------------------------------------- |
| **Frontend (Next.js)**          | Next.js + Wagmi + Ethers + Maplibre     | User interface for login, form submission, profile, and map visualization. |
| **Backend (Supabase Cloud)**    | PostgreSQL + Supabase Auth + API routes | Data persistence layer for profiles, attestations, and reference tables.   |
| **Relayer (Cloudflare Worker)** | TypeScript + EAS SDK + ethers.js        | Verifies delegated signatures and posts attestations on-chain.             |
| **Blockchain (EAS)**            | Ethereum Attestation Service            | Immutable record for coral restoration attestations.                       |

---

## üë§ User Types

| Role                          | Description                                                 |
| ----------------------------- | ----------------------------------------------------------- |
| **Researcher / Organization** | Creates profile and submits coral restoration attestations. |
| **Public Viewer**             | Views profiles, attestation map, and proof of work.         |
| **Admin (optional)**          | Manages coral species list and schema updates.              |

---

## üß† User Flow

### 1Ô∏è‚É£ Onboarding / Login

* Connect MetaMask wallet.
* Backend checks if wallet exists in profiles.
* If not, prompt user to create a profile.

### 2Ô∏è‚É£ Attestation Submission

* User fills attestation form (regen type, location, date, depth, surface area, species, summary, contributor).
* App stores attestation draft in Supabase.
* User signs delegated message ‚Üí sent to relayer.
* Relayer posts attestation ‚Üí returns UID.
* UID stored in Supabase.

### 3Ô∏è‚É£ Map Visualization

* Fetch all attestations.
* Display interactive markers on MapLibre.

### 4Ô∏è‚É£ Profile Page

* Public route `/profile/[handle]` displays profile details and attestation history.

---

## üóÑÔ∏è Database Schema (Supabase)

### Table: `profiles`

| Column         | Type      | Notes                           |
| -------------- | --------- | ------------------------------- |
| id             | uuid (PK) | Auto                            |
| wallet_address | string    | Unique, case-sensitive          |
| org_name       | string    | Organization or researcher name |
| website        | string    | Optional                        |
| description    | text      |                                 |
| handle         | string    | Auto-generated, editable        |

### Table: `attestations`

| Column           | Type                                        | Notes                                           |
| ---------------- | ------------------------------------------- | ----------------------------------------------- |
| id               | uuid (PK)                                   | Auto                                            |
| uid              | string                                      | EAS attestation UID                             |
| profile_id       | uuid (FK)                                   | references `profiles.id`                        |
| regen_type       | enum('transplantation', 'nursery', 'other') |                                                 |
| action_date      | date                                        |                                                 |
| location_lat     | decimal                                     |                                                 |
| location_lng     | decimal                                     |                                                 |
| depth            | numeric                                     | meters                                          |
| surface_area     | numeric                                     | m¬≤                                              |
| species          | text[]                                      | multi-select from predefined coral species list |
| summary          | text                                        |                                                 |
| contributor_name | text[]                                      | array of contributor names                      |
| created_at       | timestamp                                   | default now()                                   |

### Table: `coral_species`

| Column      | Type      | Notes           |
| ----------- | --------- | --------------- |
| id          | uuid (PK) | Auto            |
| common_name | string    | Display name    |
| latin_name  | string    | Scientific name |

#### Initial Placeholder Data (10 options)

1. Elkhorn coral (*Acropora palmata*)
2. Brain coral (*Diploria labyrinthiformis*)
3. Bubble coral (*Plerogyra sinuosa*)
4. Mushroom coral (*Fungia fungites*)
5. Acropora palmata (*Acropora palmata*)
6. Grooved brain coral (*Diploria strigosa*)
7. Tube coral (*Tubastraea coccinea*)
8. Black coral (*Antipatharia*)
9. Finger coral (*Porites porites*)
10. Star coral (*Montastraea cavernosa*)

---

## üßæ EAS Schema (on-chain)

| Field               | Type       | Description                                      |
| ------------------- | ---------- | ------------------------------------------------ |
| recipient           | address    | Recipient of attestation (supplied separately)   |
| regenType           | string     | Restoration type (transplantation/nursery/other) |
| regenLocation       | string[]   | `[lat, lng]` as strings                          |
| regenDate           | string     | Human-readable date (e.g., `MM-DD-YYYY`)         |
| depthScaled         | uint256    | Depth in meters √ó100 (e.g., 3.50 ‚Üí 350)          |
| surfaceAreaScaled   | uint256    | Area in m¬≤ √ó100 (e.g., 12.34 ‚Üí 1234)             |
| species             | string[]   | Selected coral species                            |
| summary             | string     | Short activity summary                            |
| contributors        | string[]   | Contributor names                                 |

---

## ‚öôÔ∏è API / Integration Points

Relayer (Cloudflare Worker)
- POST `RELAYER_URL` (proxied via Next: `POST /api/relay`)
  - Body: `{ attester, delegatedAttestation }` from EAS SDK `signDelegatedAttestation`
  - Verifies signature ‚Üí `attestByDelegation` ‚Üí returns `{ uid, txHash }`

Next.js API (server ‚Üí Supabase)
- POST `/api/profiles/upsert` ‚Üí `{ wallet_address, org_name?, website?, description?, handle? }`
- GET  `/api/profiles/by-wallet?address=0x‚Ä¶` ‚Üí `{ handle | null }`
- POST `/api/attestations/create` ‚Üí create draft (date/lat/lng required)
- POST `/api/attestations/set-uid` ‚Üí set `{ uid }` after successful relay
- GET  `/api/attestations/public` ‚Üí GeoJSON FeatureCollection for MapLibre

---

## üß± Frontend Architecture

| Page    | Route               | Description                          |
| ------- | ------------------- | ------------------------------------ |
| Home    | `/`                 | Overview + CTA to Attest             |
| Connect | `/connect`          | ‚ÄúPlease connect with MetaMask‚Ä¶‚Äù CTA  |
| Attest  | `/attest`           | Wallet connect + delegated form      |
| Map     | `/map`              | MapLibre + attestation markers       |
| Profile | `/profile/[handle]` | Profile card + attestation history   |

**Shared components:** Wallet Connect, Attestation Form, Map Pins, Profile Card, Attestation List.

---

## üóìÔ∏è Development Phases & Task Breakdown

### **Phase 1 ‚Äî Core Infrastructure and backend** ‚Äî ‚úÖ Completed
### **Phase 2 ‚Äî Prepare EAS schema** ‚Äî ‚úÖ Completed (OP Sepolia)
### **Phase 3 ‚Äî Frontend Foundations** ‚Äî ‚úÖ Completed
### **Phase 4 ‚Äî Relayer Integration** ‚Äî ‚úÖ Completed
### **Phase 5 ‚Äî Frontend integration** ‚Äî ‚úÖ Completed
### **Phase 6 ‚Äî Visualization & Profiles** ‚Äî ‚úÖ Completed (baseline)
### **Phase 7 ‚Äî QA & Launch** ‚Äî ‚ñ∂ In progress

---

## üîÆ Future Iterations (Post-MVP)

* IPFS / Storacha for dataset storage
* Embedded wallet onboarding


---

**End of Document**
