# Reef.Regen — EAS Schema v0.4 Deployment (DB‑aligned)

**Status:** Draft ⟶ Ready to deploy
**Owner:** Reef.Regen
**Scope:** Align the new EAS schema with the latest DB update. Some fields are hardcoded on the frontend (FE) and **not** persisted in DB.

---

## 1) Goals

* Keep DB and EAS payloads consistent while allowing FE-only constants.
* Make location ordering explicit (GeoJSON-style **[lon, lat]** array).
* Provide a single source of truth for types, validation, and data flow.

---

## 2) Canonical EAS Schema (v0.4)

> EAS types are chosen for compatibility and simplicity (strings for text/decimal values; uint256 for numeric measures; arrays where supported).

```
string organizationName,
string[] reefRegenAction,
string actionDate,        // single date OR range: "YYYY-MM-DD" or "YYYY-MM-DD ~ YYYY-MM-DD"
string siteName,
string siteType,
string[] location,       // [lon, lat] as array of strings
string locationType,      // FE hardcoded: "coordinate-decimal/lon-lat"
string srs,               // FE hardcoded: "EPSG:4326"
uint256 siteDepthM,       // meters
uint256 siteAreaSqM,      // square meters
string actionSummary,
string[] biodiversity,    // taxa or descriptors
string[] contributors,    // names or handles
string fileName,          // supported file name
string ipfsCID            // IPFS content id
```

**Notes**

* **Location** stored as an array `[lon, lat]` (GeoJSON/RFC 7946 order).
* If your SchemaEncoder/tooling does **not** support array tuples, store as two strings but maintain lon-first order.

---

## 3) Field Reference (type · source · persistence)

| Field                |         EAS type | Source of truth                                 | Persist to DB? | Persist to EAS? | Notes                                                                                                                                              |
| -------------------- | ---------------: | ----------------------------------------------- | -------------: | --------------: | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **organizationName** |           string | Profile table (user’s org/profile name)         |              ✅ |               ✅ | Denormalize into EAS for readability.                                                                                                              |
| **reefRegenAction**  |         string[] | UI select sourced from **regen_type.name**      |              ✅ |               ✅ | Use the **exact action names** from `regen_type.name` (e.g., "Coral Gardening - Microfragmentation"). Do **not** store or transmit the `category`. |
| **actionDate**       |           string | UI control (ISO 8601 date or range)             |              ✅ |               ✅ | e.g., `2025-10-31 ~ 2025-11-02`.                                                                                                                   |
| **siteName**         |           string | Site table                                      |              ✅ |               ✅ | Denormalize for EAS.                                                                                                                               |
| **siteType**         |           string | Site table                                      |              ✅ |               ✅ | e.g., `nursery`, `outplant`, etc.                                                                                                                  |
| **location**         | [string, string] | Site table                                      |   (site table) |               ✅ | Stored as `[lon, lat]` array in EAS; DB keeps canonical lon/lat in Site.                                                                           |
| **locationType**     |           string | **FE hardcoded** `"coordinate-decimal/lon-lat"` |              ❌ |               ✅ | **Not written to DB**.                                                                                                                             |
| **srs**              |           string | **FE hardcoded** `"EPSG:4326"`                  |              ❌ |               ✅ | **Not written to DB**.                                                                                                                             |
| **siteDepthM**       |          uint256 | Site table                                      |              ✅ |               ✅ | meters, integer; see validation.                                                                                                                   |
| **siteAreaSqM**      |          uint256 | Site table                                      |              ✅ |               ✅ | square meters, integer.                                                                                                                            |
| **actionSummary**    |           string | UI textarea                                     |              ✅ |               ✅ | Short plain‑text summary.                                                                                                                          |
| **biodiversity**     |         string[] | UI select (options from Taxa table)             |              ✅ |               ✅ | Store the chosen labels/IDs as strings.                                                                                                            |
| **contributors**     |         string[] | UI input                                        |              ✅ |               ✅ | Also stored in `attestation.contributor`.                                                                                                          |
| **fileName**         |           string | UI upload                                       |              ✅ |               ✅ | Human‑readable file name.                                                                                                                          |
| **ipfsCID**          |           string | IPFS upload result (Filebase)                   |              ✅ |               ✅ | CID only (no gateway URL).                                                                                                                         |

---

## 4) DB Mapping (summary)

**Tables touched**

* `profile` (read organizationName)
* `site` (read siteName, siteType, longitude, latitude, siteDepthM, siteAreaSqM)
* `regen_type` (read **name** values used to populate `reefRegenAction` options)
* `taxa` (read options for biodiversity)
* `attestation` (write reefRegenAction, actionDate, actionSummary, biodiversity[], contributors[], fileName, ipfsCID, organizationName, siteName, siteType, FK → site)
  (write reefRegenAction, actionDate, actionSummary, biodiversity[], contributors[], fileName, ipfsCID, organizationName, siteName, siteType, FK → site)

**Not stored in DB**

* `locationType` (FE constant `coordinate-decimal/lon-lat`)
* `srs` (FE constant `EPSG:4326`)

> Gateway URLs may be derived at read time using the stored `ipfsCID` plus the configured gateway; no separate DB column is required unless you need a fixed, user‑visible link snapshot.

---

## 5) Validation & Conventions

* **Action date**: accept either a single date `YYYY-MM-DD` **or** a range formatted `YYYY-MM-DD ~ YYYY-MM-DD` (no spaces around tilde also permitted). Validate that end ≥ start.
* **Location array**: `[lon, lat]` in decimal degrees, both as strings; precision ≥ 6 decimal places. Example: `["120.987654", "14.123456"]`.
* **Depth & Area**: non‑negative integers (`uint256`). If fractional values are needed later, switch to fixed‑point strings.
* **Arrays**: limit 25 items per array to keep on‑chain data small.
* **Text lengths**: `actionSummary` ≤ 1024 chars; `fileName` ≤ 256 chars; `organizationName/siteName` ≤ 140 chars.

---

## 6) Fallback (if arrays unsupported by tooling)

If your current EAS encoder does not support array types, use these substitutes:

```
string reefRegenActionCSV, // join with ","
string biodiversityCSV,    // join with ","
string contributorsCSV     // join with ","
string locationCSV         // join as "lon,lat"
```

**Delimiter rules**

* Use literal commas; escape commas in values by wrapping entries in quotes during join/split.
* Document at the API boundary and add unit tests for round‑trip integrity.

---

## 7) Example Payloads

### 7.1 EAS encode input (arrays supported)

```json
{
  "organizationName": "Coral Care Initiative",
  "reefRegenAction": ["Coral Gardening - Microfragmentation", "Substrate Addition - Artificial reef"],
  "actionDate": "2025-10-31 ~ 2025-11-02",
  "siteName": "North Reef Nursery A",
  "siteType": "nursery",
  "location": ["120.987654", "14.123456"],
  "locationType": "coordinate-decimal/lon-lat",
  "srs": "EPSG:4326",
  "siteDepthM": 7,
  "siteAreaSqM": 400,
  "actionSummary": "Installed new limestone modules and attached 120 fragments.",
  "biodiversity": ["Acropora cervicornis", "Pocillopora damicornis"],
  "contributors": ["@reefdao/alex", "Ocean Org"],
  "fileName": "module-install-2025-10-31.zip",
  "ipfsCID": "bafybeigdyr..."
}
```

"actionDate": "2025-10-31 ~ 2025-11-02",
"siteName": "North Reef Nursery A",
"siteType": "nursery",
"location": ["120.987654", "14.123456"],
"locationType": "coordinate-decimal/lon-lat",
"srs": "EPSG:4326",
"siteDepthM": 7,
"siteAreaSqM": 400,
"actionSummary": "Installed new limestone modules and attached 120 fragments.",
"biodiversity": ["Acropora cervicornis", "Pocillopora damicornis"],
"contributors": ["@reefdao/alex", "Ocean Org"],
"fileName": "module-install-2025-10-31.zip",
"ipfsCID": "bafybeigdyr..."
}

````

### 7.2 DB `attestation` insert (minimal)
```json
{
  "organization_name": "Coral Care Initiative",
  "reef_regen_action": ["Coral Gardening - Microfragmentation", "Substrate Addition - Artificial reef"],
  "action_date": "2025-10-31 ~ 2025-11-02",
  "site_id": "<fk_site_uuid>",
  "site_name": "North Reef Nursery A",
  "site_type": "nursery",
  "site_depth_m": 7,
  "site_area_sqm": 400,
  "action_summary": "Installed new limestone modules and attached 120 fragments.",
  "biodiversity": ["Acropora cervicornis", "Pocillopora damicornis"],
  "contributors": ["@reefdao/alex", "Ocean Org"],
  "file_name": "module-install-2025-10-31.zip",
  "ipfs_cid": "bafybeigdyr...",
  "show_on_map": true
}
````


---

## 8) FE Implementation Notes
- **Constants**:
  - `LOCATION_TYPE = "coordinate-decimal/lon-lat"`
  - `SRS = "EPSG:4326"`
- **Map picker**: ensure lon/lat order in UI; persist to Site table as separate columns, but emit to EAS as `location = [lon,lat]`.
- **Reef Regen Action options**: query `regen_type` and display the **`name`** field; optional helper text can display `std_label`/`description`, but only `name` is submitted to EAS and stored in DB.
- **Action date control**: allow single date or date-range; when range chosen, format `YYYY-MM-DD ~ YYYY-MM-DD`.
- **Precision**: display with 6–7 decimals; store strings as provided by Site.
- **Upload flow**: upload → receive CID → set `fileName` + `ipfsCID` → sign EAS.

- **Precision**: display with 6–7 decimals; store strings as provided by Site.
- **Upload flow**: upload → receive CID → set `fileName` + `ipfsCID` → sign EAS.

---

## 9) Rollout Checklist
1. [ ] Update Schema string in codebase (contract/schema registry as needed).  
2. [ ] Add FE constants (`LOCATION_TYPE`, `SRS`).  
3. [ ] Ensure Site model stores lon/lat separately and in **lon, lat** order; EAS payload composes `location` as `[lon,lat]`.
4. [ ] Add validations (date/range, non‑negative uints, array sizes).  
5. [ ] Adjust DB writes: exclude `locationType` & `srs`.  
6. [ ] Unit tests: payload shaping, CSV fallback (if used), round‑trip.  
7. [ ] Staging attestation → verify on EAS scan.  
8. [ ] Migration notes communicated to team.

---

## 10) Future considerations
- If EAS array support becomes limiting, consider compact JSON string fields for complex structures.  
- Consider storing gateway URL in DB only if you need a **stable, user-curated** link; otherwise derive on read.

```
