# Reef.Regen — Attestation Wizard

## Step 5: Contributors

**Goal:** Let users optionally credit contributors. Store as `attestation.contributors: string[]` in the wizard state (client-only). Clicking **Review** proceeds to the review/submit screen.

---

## 1) UX

**Title:** “Lastly, give contributors credits.”
**Control:** single multiline textarea with placeholder

> “Jane Smith, John Smith, John Doe …”

**Helper text:** “Add names separated by comma, semicolon, or new line. Optional.”

**Footer:** **Back** | **Review** (always enabled). Show “Saved • HH:MM” when state persists.

**Live feedback (inline, under textarea):**

* “3 contributors added” (updates as user types)
* If any invalid tokens: “We skipped 1 empty name” (non-blocking)

---

## 2) State (Zustand + persist)

```ts
type WizardState = {
  // ...
  contributors: string[];       // canonical array form
  contributorsInput?: string;   // raw textarea (for perfect restore)
  lastSavedAt?: number;
}
```

* Persist both `contributors` and `contributorsInput`.
* `contributors` is the **source of truth** for later steps/submit.
* Update `lastSavedAt` on every debounced change.

---

## 3) Parsing & normalization

Parse the textarea on each change (debounced ~250ms):

* **Split on:** commas `,`, semicolons `;`, and newlines `\n`.
* **Trim** surrounding whitespace of each token.
* **Collapse internal whitespace** to single spaces (e.g., “  Jane   Doe ” → “Jane Doe”).
* **Remove empties** and **dedupe** (case-insensitive).
* **Length guards:** each name 2–80 chars; discard outside range.
* **Unicode safe:** allow diacritics and non-Latin characters.

Example:

```
" Jane Smith;  JOHN smith\nDr. A. Coral  "
→ ["Jane Smith", "John Smith", "Dr. A. Coral"]
```

> Parsing is non-blocking: we quietly drop empties/invalid tokens and show a small hint.

---

## 4) Component behavior

* **On mount:** hydrate `contributorsInput` into the textarea; derive `contributors` from it if missing.
* **On change:** update `contributorsInput` immediately; after debounce:

  * compute `parsed = parseContributors(contributorsInput)`
  * `setPatch({ contributors: parsed })`
* **On blur:** run the same parse to ensure store is up-to-date.
* **Back/Review navigation:** does not require any value; just updates `currentStep`.

---

## 5) Accessibility & keyboard

* Textarea has `aria-label="Contributors"`.
* Describe separators in `aria-describedby`.
* 4 lines min height; grows vertically (but capped to avoid layout jumps).

---

## 6) Limits & safeguards

* Max **100 names** (silently ignore extras and show “limit reached” hint).
* Disallow leading/trailing punctuation (e.g., trailing comma) via parser cleanup.
* No special validation for emails/handles—treat as plain strings (future enhancement: detect and strip `@` or emails if undesired).

---

## 7) Persistence & autosave

* Debounce saves (250ms) to reduce localStorage churn.
* Show “Saved • HH:MM” after each debounced commit.
* Fully restores after reload (textarea value + computed list).

---

## 8) Review hand-off

When the user presses **Review**, the review screen reads `state.contributors` (the canonical array).
Final submit includes:

```ts
payload.contributors = state.contributors; // string[]
```

No server calls are made in Step 5 (Option A: client-only).

---

## 9) QA checklist

* Typing names with mixed separators yields correct count.
* Duplicate names (any casing) collapse to one.
* Empty tokens (e.g., trailing comma/newline) are ignored.
* Very short/long tokens are dropped with a soft hint.
* Navigation Back/Review preserves textarea content and computed array.
* Reload restores both `contributorsInput` and `contributors`.

---

## 10) Minimal utility

```ts
export function parseContributors(input: string): string[] {
  return Array.from(new Set(
    input
      .split(/[,;\n]/g)
      .map(t => t.trim().replace(/\s+/g, ' '))
      .filter(t => t.length >= 2 && t.length <= 80)
      .map(t => t) // keep original case
  ));
}
```
