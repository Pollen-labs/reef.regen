# Reef.Regen â€” Attestation Wizard

## Step 6: Review & Submit (Finalized Simple Flow)

**Purpose:**
Allow users to carefully review all submitted data before finalizing their attestation.
Once confirmed, the app performs a *single, atomic submission flow* â€”
upload â†’ sign â†’ relay â†’ create DB record.
If the user closes the page before completion, no partial data is written to the backend.

---

## ğŸ§­ Overview

### UX Summary

* Display all information from previous steps.
* Each section includes a âœï¸ **edit icon** to navigate back to that specific step.
* Include the organization name (profile) as â€œsubmitted by.â€
* Provide an optional **Internal ID** input for usersâ€™ own tracking.
* CTA: **â€œLooks good, submitâ€** triggers final submission.

---

## ğŸ§© UI Sections

| Section             | Source                                             | Editable?    | Notes                                   |
| ------------------- | -------------------------------------------------- | ------------ | --------------------------------------- |
| **Regen action(s)** | `reefRegenActions[]`                               | Yes (Step 1) | Display as colored chips                |
| **Action date**     | `actionDate` / `actionStart` â†’ `actionEnd`         | Yes (Step 2) | Format `MM DD, YYYY` or `MM DD ~ MM DD` |
| **Site info**       | `siteName`, `siteType`, `siteDepthM`, `siteAreaM2` | Yes (Step 2) | 2-column grid                           |
| **Regen summary**   | `summary`                                          | Yes (Step 3) | Full paragraph                          |
| **Attachment**      | `fileName`                                         | Yes (Step 3) | Filename only                           |
| **Species**         | `species[]`                                        | Yes (Step 4) | Display as blue chips â€œName Countâ€      |
| **Contributors**    | `contributors[]`                                   | Yes (Step 5) | Comma-separated                         |
| **Submitting as**   | `organizationName`                                 | No           | Read-only                               |
| **Internal ID**     | `internalId`                                       | Yes          | Editable local field                    |



## Layout & Components

**Title:** â€œReview your submissionâ€
**Subtext:**

> â€œPlease review your submission thoroughly as it will be permanently submitted to the blockchain and cannot be edited later.â€

**Sections displayed:**

1. Regen Action(s)
2. Action Date & Site Info
3. Summary & Attachment
4. Coral Species
5. Contributors
6. Submission identity (their org profile name)
7. Internal ID (optional field)

**Footer:**

* **Back** button â€” returns to Step 5
* **Looks good, submit** button â€” triggers EAS submission process

Each section has a **pencil icon (âœï¸)** for quick edit â†’ clicking it navigates back to the corresponding step.

Each section is rendered as a **card** with the following:

* Section title (e.g., â€œRegen action(s)â€)
* Content from stored state (user selections, text, file, etc.)
* Top-right edit icon (navigates back)

Example:

```
[Regen action(s)]           [âœï¸]
Microfragmentation, Nursery
```

**Styling:**

* Uniform background for cards (slightly lighter shade than page background)
* Rounded corners, 2xl border-radius
* Hover state on edit icon (opacity + cursor pointer)




---

## ğŸ§  State Model (Zustand)

Extend the store minimally:

```ts
type WizardState = {
  // existing fields from steps 1-5...
  internalId?: string;
  submitting?: boolean;            // disables UI during submission
  submitPhase?: 'idle' | 'upload' | 'sign' | 'relay' | 'done' | 'failed';
  submitError?: string | null;
};
```

---

## âš™ï¸ Behavior

### Edit navigation

Each âœï¸ icon triggers:

```ts
router.push(`/submit/steps/${stepNumber}`)
```

### Internal ID input

* Optional text (max 40 chars, `[A-Za-z0-9-_ ]`)
* Stored locally only; not required.
* Updated with debounce 250 ms:

  ```ts
  setPatch({ internalId })
  ```

---

## ğŸš€ Submission Flow (Simple Atomic Flow)

### 1ï¸âƒ£ When user clicks **â€œLooks good, submitâ€**

* Lock the UI.
* Show a blocking overlay with a 3-step indicator:

  1. Uploading file
  2. Signing attestation
  3. Broadcasting to network
* Add `beforeunload` handler warning if they attempt to close the page.

### 2ï¸âƒ£ Upload file (if any)

```ts
if (state.fileBlob) {
  const { cid, url } = await uploadToIPFS(state.fileBlob);
  setPatch({ fileCid: cid, fileUrl: url });
}
```

* On failure â†’ show toast â€œUpload failed, please retry.â€ Stop submission.
* If user closes tab before this finishes â†’ no DB writes, safe cancel.

### 3ï¸âƒ£ Sign & relay to EAS

```ts
const easUID = await signAndRelayToEAS(buildEASPayload(state));
```

* On wallet rejection or network failure â†’ show toast â€œSigning cancelled / failed.â€
* No DB writes yet.

### 4ï¸âƒ£ Create DB record (only after EAS UID exists)

```ts
await api.post('/api/attestations', {
  ...buildDBRecord(state),
  eas_uid: easUID,
});
```

* The backend **must require** `eas_uid` to insert â€” this prevents orphan drafts.
* Server validates UID + schema + signer.

### 5ï¸âƒ£ Complete

* Reset store (`reset()`).
* Redirect â†’ `/submit/success?uid=<easUID>`.

---

## ğŸ§¯ Error Handling

| Stage                   | User Message                                   | Recovery                         |
| ----------------------- | ---------------------------------------------- | -------------------------------- |
| Upload failed           | â€œUpload failed. Please retry.â€                 | Retry button re-calls upload.    |
| Signing rejected        | â€œSigning cancelled â€” submission not sent.â€     | Return to Review screen.         |
| Relay timeout           | â€œNetwork busy. Try again.â€                     | Retry re-runs relay only.        |
| DB create failed (rare) | Save `pendingFinalize = { eas_uid, snapshot }` | Prompt on next load to finalize. |

---

## ğŸ”’ Blocking overlay UX

During submission:

| Phase    | Display text                                              |
| -------- | --------------------------------------------------------- |
| `upload` | â€œUploading your file to IPFSâ€¦ Please keep this tab open.â€ |
| `sign`   | â€œRequesting attestation signatureâ€¦â€                       |
| `relay`  | â€œBroadcasting to networkâ€¦â€                                |
| `done`   | â€œSubmission complete.â€                                    |

Include spinner + progress bar; disable all navigation.

---

## ğŸ—ƒï¸ Backend contract

**POST `/api/attestations`**

```json
{
  "organization_name": "Coral Guardians Initiative",
  "reef_regen_actions": ["Microfragmentation", "Nursery"],
  "site": {
    "name": "East side coral",
    "type": "Nursery",
    "depth_m": 3,
    "area_m2": 167,
    "location": [99.842, 10.113]
  },
  "action_date": "07-07-2025",
  "summary": "Coral reef regeneration involves nurturing coral fragments...",
  "file": {
    "name": "filename.pdf",
    "cid": "bafybeihashcidexample",
    "url": "https://gateway.filebase.io/ipfs/bafybeihashcidexample"
  },
  "species": [
    { "name": "Heterogorgia tortuosa", "count": 31 },
    { "name": "Acanella arbuscula", "count": 52 }
  ],
  "contributors": ["Erick Palau", "James Creek", "Sarah Bolin"],
  "internal_id": "CORAL-113",
  "eas_uid": "0xâ€¦"
}
```

**Server must:**

* Reject if `eas_uid` is missing.
* Verify UID and signer.
* Insert only on valid attestation.
* Return `201 Created`.

---

## ğŸ§© State resets after success

```ts
reset();          // clear persisted wizard
router.replace(`/submit/success?uid=${easUID}`);
```

---

## âœ… QA Checklist

* All data from steps 1â€“5 displayed correctly.
* Edit icons navigate to correct steps.
* Internal ID persists locally.
* Submit button triggers upload â†’ sign â†’ relay â†’ create â†’ redirect.
* Closing tab during submission cancels safely (no orphan DB data).
* Success screen shows EAS UID + â€œView on EAScanâ€ link.

---

## ğŸ’¡ Summary

| Feature           | Design choice                          |
| ----------------- | -------------------------------------- |
| Resume drafts     | âŒ None (keep it simple)                |
| Partial DB writes | âŒ Prevented                            |
| IPFS upload       | âœ… Client-side only                     |
| Signing flow      | âœ… Background; user sees progress bar (TBD)  |
| Final record      | âœ… Created **only** after valid EAS UID |
| Recovery          | âœ… Optional finalize if DB write fails  |




# Important Notes â€” Network & Relay

- Auto network switch
  - Detects current chain via wallet/viem and switches to the expected chain (`NEXT_PUBLIC_CHAIN_ID`, Optimism Sepolia 11155420) using `walletClient.switchChain({ id })` before any onâ€‘chain reads.
  - If switching fails, the user sees a clear wrongâ€‘network error and submission stops.

- EAS contract preflight
  - Verifies `NEXT_PUBLIC_EAS_ADDRESS` has bytecode on the active chain. If not, submission stops with a clear message (prevents â€œgetNonce returned 0xâ€ errors).

- Delegated signing (EAS SDK)
  - Encodes data with SchemaEncoder for this schema:
    `string organizationName,string[] reefRegenAction,string actionDate,string siteName,string siteType,string[] location,string locationType,string srs,uint256 siteDepthM,uint256 siteAreaSqM,string actionSummary,string[] biodiversity,string[] contributors,string fileName,string ipfsCID`.
  - Uses `eas.getDelegated().signDelegatedAttestation` with:
    - `recipient`: connected wallet (or provided override)
    - `expirationTime`: no expiration
    - `revocable`: true
    - `refUID`: zero bytes32
    - `value`: 0n
    - `nonce`: read from `eas.getNonce(attester)`
    - `deadline`: now + 30 minutes (seconds since epoch) to avoid slowâ€‘network expiries
  - Ensures the outgoing payload explicitly carries `message.deadline` and `message.nonce` values (matches AttestationForm behavior).

- Relay payload (what the worker expects)
  - Client POSTs to `/api/relay` (server proxy â†’ `RELAYER_URL`) with:
    `{ attester: 0x..., delegatedAttestation: { domain, types, primaryType: 'Attest', message, signature } }`
  - Bigints are serialized to strings by the client. Worker must coerce to bigint safely.
  - Worker validates schema, nonce, signature, and deadline; then relays `attestByDelegation` and returns `{ uid, txHash }`.
  - Typical error codes: `BAD_NONCE`, `DEADLINE_EXPIRED`, `INVALID_SIGNATURE`.

- Upload â†’ Sign â†’ Relay â†’ Finalize (atomic)
  - File (if any) uploads to IPFS first; CID + gateway URL stored locally.
  - No DB writes until after relay returns a valid `uid`.
  - Finalize API requires `eas_uid` and inserts the attestation + joins; prevents orphan drafts by design.

- Success & reset
  - On success: reset the wizard store and redirect to `/submit/success?uid=<uid>`.


# Reef.Regen â€” Attestation Wizard

## Step 6: Review & Submit

**Goal:**
Let users review all information they entered across previous steps before final submission to the blockchain (EAS).
They can revise specific sections, add an optional internal ID (for their own record-keeping), and finally confirm submission.
Once submitted, data becomes immutable on-chain.

---

